<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡ç« ç®¡ç† - å†™æ–‡ç« </title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #f8f9fa;
      --bg-card: #ffffff;
      --bg-sidebar: #ffffff;
      --text: #1a1a2e;
      --text-secondary: #666;
      --border: #e8e8e8;
      --primary: #6c5ce7;
      --primary-light: #a29bfe;
      --danger: #e74c3c;
      --success: #27ae60;
      --radius: 12px;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'Inter', 'Noto Serif SC', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== Top Bar ===== */
    .topbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .topbar__left { display: flex; align-items: center; gap: 16px; }
    .topbar__logo { font-size: 18px; font-weight: 700; color: var(--primary); text-decoration: none; }
    .topbar__divider { width: 1px; height: 24px; background: var(--border); }
    .topbar__title { font-size: 14px; color: var(--text-secondary); }
    .topbar__actions { display: flex; gap: 10px; }
    .topbar__link {
      font-size: 13px; color: var(--text-secondary); text-decoration: none;
      padding: 6px 12px; border-radius: 6px; transition: all 0.2s;
    }
    .topbar__link:hover { background: var(--bg); color: var(--primary); }

    /* ===== Tabs ===== */
    .admin-tabs {
      display: flex;
      gap: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
    }
    .admin-tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-family: inherit;
    }
    .admin-tab:hover { color: var(--primary); }
    .admin-tab--active { color: var(--primary); border-bottom-color: var(--primary); }

    /* ===== Layout ===== */
    .layout { display: flex; height: calc(100vh - 56px - 44px); }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar__header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar__title { font-size: 14px; font-weight: 600; }
    .sidebar__count { font-size: 12px; color: var(--text-secondary); background: var(--bg); padding: 2px 8px; border-radius: 10px; }
    .sidebar__list { flex: 1; overflow-y: auto; padding: 8px; }
    .sidebar__item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 4px;
      border: 2px solid transparent;
    }
    .sidebar__item:hover { background: var(--bg); }
    .sidebar__item--active { background: #f0eeff; border-color: var(--primary); }
    .sidebar__item-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .sidebar__item-meta { font-size: 12px; color: var(--text-secondary); display: flex; gap: 8px; }
    .sidebar__item-category {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 4px;
      background: var(--bg);
      color: var(--primary);
    }
    .sidebar__footer { padding: 12px; border-top: 1px solid var(--border); }
    .btn-new {
      width: 100%;
      padding: 10px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-new:hover { background: #5b4bd5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(108,92,231,0.3); }

    /* ===== Main Editor ===== */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Settings Bar */
    .settings-bar {
      padding: 16px 24px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .setting-group { display: flex; align-items: center; gap: 8px; }
    .setting-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; white-space: nowrap; }
    .setting-select, .setting-input {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: var(--bg);
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }
    .setting-select:focus, .setting-input:focus { border-color: var(--primary); }
    .setting-input--tags { width: 200px; }
    .setting-input--emoji { width: 50px; text-align: center; font-size: 18px; }
    .setting-color {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .setting-color:hover, .setting-color--active { border-color: var(--text); transform: scale(1.15); }
    .color-picker { display: flex; gap: 6px; align-items: center; }
    .switch-group { display: flex; align-items: center; gap: 6px; }
    .switch {
      width: 36px; height: 20px;
      background: #ccc;
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }
    .switch::after {
      content: '';
      width: 16px; height: 16px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 2px; left: 2px;
      transition: transform 0.2s;
    }
    .switch--on { background: var(--primary); }
    .switch--on::after { transform: translateX(16px); }

    /* Title Input */
    .title-input {
      border: none;
      outline: none;
      font-size: 28px;
      font-weight: 700;
      padding: 24px 32px 8px;
      background: transparent;
      font-family: inherit;
      color: var(--text);
      width: 100%;
    }
    .title-input::placeholder { color: #ccc; }

    /* Toolbar */
    .toolbar {
      padding: 8px 32px;
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .toolbar__btn {
      padding: 6px 10px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.15s;
      line-height: 1;
    }
    .toolbar__btn:hover { background: var(--bg); color: var(--text); }
    .toolbar__btn--active { background: #f0eeff; color: var(--primary); }
    .toolbar__sep { width: 1px; background: var(--border); margin: 2px 6px; }

    /* Rich Text Editor */
    .editor-scroll { flex: 1; min-height: 0; overflow-y: auto; background: var(--bg-card); }
    .rich-editor {
      min-height: 400px;
      padding: 16px 32px 100px;
      outline: none;
      font-size: 16px;
      line-height: 1.8;
      color: var(--text);
      max-width: 800px;
    }
    .rich-editor:empty::before {
      content: 'å¼€å§‹å†™ä½ çš„æ–‡ç« ...';
      color: #ccc;
      pointer-events: none;
    }
    .rich-editor h2 { font-size: 22px; margin: 24px 0 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .rich-editor h3 { font-size: 18px; margin: 20px 0 8px; }
    .rich-editor p { margin-bottom: 12px; }
    .rich-editor blockquote {
      border-left: 4px solid var(--primary);
      padding: 12px 16px;
      margin: 16px 0;
      background: #f8f7ff;
      border-radius: 0 8px 8px 0;
      color: var(--text-secondary);
    }
    .rich-editor ul, .rich-editor ol { margin: 12px 0; padding-left: 24px; }
    .rich-editor li { margin-bottom: 4px; }
    .rich-editor pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      overflow-x: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
    }
    .rich-editor code {
      background: #f0eeff;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--primary);
    }
    .rich-editor pre code { background: none; padding: 0; color: inherit; }
    .rich-editor img { max-width: 100%; border-radius: 8px; margin: 12px 0; }

    /* Action Buttons */
    .action-bar {
      padding: 12px 24px;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      position: relative;
      z-index: 20;
    }
    .action-bar__left { display: flex; gap: 8px; }
    .action-bar__right { display: flex; gap: 8px; }
    .btn {
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn--primary { background: var(--primary); color: #fff; }
    .btn--primary:hover { background: #5b4bd5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(108,92,231,0.3); }
    .btn--danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
    .btn--danger:hover { background: var(--danger); color: #fff; }
    .btn--ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .btn--ghost:hover { background: var(--bg); color: var(--text); }
    .btn--small { padding: 4px 12px; font-size: 12px; }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 72px;
      right: 24px;
      padding: 12px 20px;
      background: var(--success);
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      z-index: 9999;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .toast--show { transform: translateX(0); }
    .toast--error { background: var(--danger); }

    /* Empty State */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }
    .empty-state__icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state__text { font-size: 16px; margin-bottom: 24px; }

    /* ===== Login Overlay ===== */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .login-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 40px 48px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.12);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-card__icon { font-size: 48px; margin-bottom: 16px; }
    .login-card__title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .login-card__sub { font-size: 14px; color: var(--text-secondary); margin-bottom: 28px; }
    .login-input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      margin-bottom: 10px;
    }
    .login-input:focus { border-color: var(--primary); }
    .login-input.login-input--error { border-color: var(--danger); animation: shake 0.3s; }
    .login-btn {
      width: 100%;
      margin-top: 4px;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .login-btn:hover { background: #5b4bd5; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108,92,231,0.3); }
    .login-error { font-size: 13px; color: var(--danger); margin-top: 10px; min-height: 18px; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    /* ===== Comments / Messages Tab ===== */
    .tab-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .tab-panel--active { display: flex; }
    .data-list { flex: 1; overflow-y: auto; padding: 16px 24px; }
    .data-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .data-item--pending { border-left: 3px solid #fdcb6e; }
    .data-item--approved { border-left: 3px solid var(--success); }
    .data-item__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .data-item__meta { font-size: 13px; color: var(--text-secondary); }
    .data-item__actions { display: flex; gap: 6px; }
    .data-item__content { font-size: 14px; line-height: 1.6; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge--pending { background: #fef9e7; color: #d68910; }
    .badge--approved { background: #eafaf1; color: var(--success); }
    .badge--unread { background: #fef9e7; color: #d68910; }
    .badge--read { background: #f0f0f0; color: #888; }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { width: 100%; position: fixed; top: 100px; left: -100%; z-index: 50; height: calc(100vh - 100px); transition: left 0.3s; }
      .sidebar--open { left: 0; }
      .settings-bar { padding: 12px 16px; }
      .title-input { padding: 16px; font-size: 22px; }
      .toolbar { padding: 8px 16px; }
      .rich-editor { padding: 16px; }
      .mobile-toggle { display: block !important; }
    }
    .mobile-toggle { display: none; background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px 8px; }
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div class="login-overlay" id="login-overlay">
    <div class="login-card">
      <div class="login-card__icon">ğŸ”</div>
      <div class="login-card__title">ç®¡ç†å‘˜ç™»å½•</div>
      <div class="login-card__sub">è¯·ä½¿ç”¨ Supabase è´¦å·ç™»å½•</div>
      <input type="email" class="login-input" id="login-email" placeholder="é‚®ç®±" autocomplete="email">
      <input type="password" class="login-input" id="login-password" placeholder="å¯†ç " autocomplete="current-password">
      <button class="login-btn" id="login-btn" onclick="submitLogin()">è¿›å…¥ç®¡ç†</button>
      <div class="login-error" id="login-error"></div>
    </div>
  </div>

  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar__left">
      <button class="mobile-toggle" onclick="toggleSidebar()">&#9776;</button>
      <a href="index.html" class="topbar__logo">Blog.</a>
      <div class="topbar__divider"></div>
      <span class="topbar__title">æ–‡ç« ç®¡ç†</span>
    </div>
    <div class="topbar__actions">
      <a href="index.html" class="topbar__link">&#127968; é¦–é¡µ</a>
      <a href="blog.html" class="topbar__link">&#128221; åšå®¢</a>
      <button class="topbar__link" onclick="logout()" style="background:none;border:none;cursor:pointer;">&#128275; é€€å‡º</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="admin-tabs">
    <button class="admin-tab admin-tab--active" onclick="switchTab('articles')">&#128221; æ–‡ç« ç®¡ç†</button>
    <button class="admin-tab" onclick="switchTab('comments')">&#128172; è¯„è®ºå®¡æ ¸</button>
    <button class="admin-tab" onclick="switchTab('messages')">&#128140; è”ç³»ç•™è¨€</button>
  </div>

  <!-- ===== Tab: Articles ===== -->
  <div class="tab-panel tab-panel--active" id="tab-articles">
    <div class="layout">
      <!-- Sidebar: Article List -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar__header">
          <span class="sidebar__title">å…¨éƒ¨æ–‡ç« </span>
          <span class="sidebar__count" id="article-count">0 ç¯‡</span>
        </div>
        <div class="sidebar__list" id="article-list">
          <!-- ç”± JS ç”Ÿæˆ -->
        </div>
        <div class="sidebar__footer">
          <button class="btn-new" onclick="createNew()">+ å†™æ–°æ–‡ç« </button>
        </div>
      </div>

      <!-- Editor Area -->
      <div class="editor-area" id="editor-area">
        <div class="empty-state" id="empty-state">
          <div class="empty-state__icon">&#9997;&#65039;</div>
          <div class="empty-state__text">é€‰æ‹©ä¸€ç¯‡æ–‡ç« ç¼–è¾‘ï¼Œæˆ–è€…å†™ä¸€ç¯‡æ–°çš„</div>
          <button class="btn btn--primary" onclick="createNew()">+ å†™æ–°æ–‡ç« </button>
        </div>

        <!-- Editor (hidden by default) -->
        <div id="editor-wrapper" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
          <!-- Settings -->
          <div class="settings-bar">
            <div class="setting-group">
              <span class="setting-label">åˆ†ç±»</span>
              <select class="setting-select" id="ed-category">
                <option value="frontend">å‰ç«¯å¼€å‘</option>
                <option value="backend">åç«¯æŠ€æœ¯</option>
                <option value="learning">å­¦ä¹ æ–¹æ³•</option>
                <option value="life">ç”Ÿæ´»éšç¬”</option>
              </select>
            </div>
            <div class="setting-group">
              <span class="setting-label">æ ‡ç­¾</span>
              <input type="text" class="setting-input setting-input--tags" id="ed-tags" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šHTML, CSS">
            </div>
            <div class="setting-group">
              <span class="setting-label">å›¾æ ‡</span>
              <input type="text" class="setting-input setting-input--emoji" id="ed-emoji" value="ğŸ“">
            </div>
            <div class="setting-group">
              <span class="setting-label">å¡ç‰‡é¢œè‰²</span>
              <div class="color-picker" id="color-picker">
                <div class="setting-color setting-color--active" data-gradient="linear-gradient(135deg, #6c5ce7, #a29bfe)" style="background:linear-gradient(135deg,#6c5ce7,#a29bfe)"></div>
                <div class="setting-color" data-gradient="linear-gradient(135deg, #fd79a8, #e17055)" style="background:linear-gradient(135deg,#fd79a8,#e17055)"></div>
                <div class="setting-color" data-gradient="linear-gradient(135deg, #00cec9, #0984e3)" style="background:linear-gradient(135deg,#00cec9,#0984e3)"></div>
                <div class="setting-color" data-gradient="linear-gradient(135deg, #55efc4, #00b894)" style="background:linear-gradient(135deg,#55efc4,#00b894)"></div>
                <div class="setting-color" data-gradient="linear-gradient(135deg, #e17055, #fdcb6e)" style="background:linear-gradient(135deg,#e17055,#fdcb6e)"></div>
                <div class="setting-color" data-gradient="linear-gradient(135deg, #0984e3, #74b9ff)" style="background:linear-gradient(135deg,#0984e3,#74b9ff)"></div>
              </div>
            </div>
            <div class="switch-group">
              <span class="setting-label">é¦–é¡µæ¨è</span>
              <button class="switch" id="ed-featured" onclick="toggleSwitch(this)"></button>
            </div>
          </div>

          <!-- Title -->
          <input type="text" class="title-input" id="ed-title" placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜...">

          <!-- Toolbar -->
          <div class="toolbar">
            <button class="toolbar__btn" onclick="fmt('formatBlock','h2')" title="æ ‡é¢˜">H2</button>
            <button class="toolbar__btn" onclick="fmt('formatBlock','h3')" title="å°æ ‡é¢˜">H3</button>
            <button class="toolbar__btn" onclick="fmt('formatBlock','p')" title="æ­£æ–‡">P</button>
            <div class="toolbar__sep"></div>
            <button class="toolbar__btn" onclick="fmt('bold')" title="åŠ ç²—"><b>B</b></button>
            <button class="toolbar__btn" onclick="fmt('italic')" title="æ–œä½“"><i>I</i></button>
            <button class="toolbar__btn" onclick="fmt('strikeThrough')" title="åˆ é™¤çº¿"><s>S</s></button>
            <div class="toolbar__sep"></div>
            <button class="toolbar__btn" onclick="fmt('insertUnorderedList')" title="æ— åºåˆ—è¡¨">&#8226; åˆ—è¡¨</button>
            <button class="toolbar__btn" onclick="fmt('insertOrderedList')" title="æœ‰åºåˆ—è¡¨">1. åˆ—è¡¨</button>
            <div class="toolbar__sep"></div>
            <button class="toolbar__btn" onclick="insertBlockquote()" title="å¼•ç”¨">&#10077; å¼•ç”¨</button>
            <button class="toolbar__btn" onclick="insertCode()" title="ä»£ç å—">&#60;/&#62; ä»£ç </button>
            <button class="toolbar__btn" onclick="insertInlineCode()" title="è¡Œå†…ä»£ç ">`ä»£ç `</button>
            <div class="toolbar__sep"></div>
            <button class="toolbar__btn" onclick="fmt('undo')" title="æ’¤é”€">&#8617; æ’¤é”€</button>
            <button class="toolbar__btn" onclick="fmt('redo')" title="é‡åš">&#8618; é‡åš</button>
          </div>

          <!-- Rich Editor -->
          <div class="editor-scroll">
            <div class="rich-editor" id="ed-content" contenteditable="true"></div>
          </div>

          <!-- Action Bar -->
          <div class="action-bar">
            <div class="action-bar__left">
              <button type="button" class="btn btn--danger" id="btn-delete">åˆ é™¤æ–‡ç« </button>
            </div>
            <div class="action-bar__right">
              <button type="button" class="btn btn--ghost" onclick="previewArticle()">é¢„è§ˆ</button>
              <button type="button" class="btn btn--primary" onclick="saveArticle()">&#10003; å‘å¸ƒä¿å­˜</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Tab: Comments ===== -->
  <div class="tab-panel" id="tab-comments">
    <div class="data-list" id="comments-data-list">
      <p style="color:#888;padding:20px 0;">åŠ è½½è¯„è®ºä¸­...</p>
    </div>
  </div>

  <!-- ===== Tab: Messages ===== -->
  <div class="tab-panel" id="tab-messages">
    <div class="data-list" id="messages-data-list">
      <p style="color:#888;padding:20px 0;">åŠ è½½ç•™è¨€ä¸­...</p>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/api.js"></script>

  <script>
    // ===== è®¤è¯ =====
    async function submitLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');
      const btn = document.getElementById('login-btn');

      if (!email || !password) {
        errEl.textContent = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
        return;
      }

      btn.textContent = 'ç™»å½•ä¸­...';
      btn.disabled = true;
      try {
        await AuthAPI.signIn(email, password);
        document.getElementById('login-overlay').style.display = 'none';
        initAdmin();
      } catch (e) {
        errEl.textContent = 'ç™»å½•å¤±è´¥ï¼š' + (e.message || 'é‚®ç®±æˆ–å¯†ç é”™è¯¯');
        document.getElementById('login-email').classList.add('login-input--error');
        setTimeout(() => document.getElementById('login-email').classList.remove('login-input--error'), 400);
      } finally {
        btn.textContent = 'è¿›å…¥ç®¡ç†';
        btn.disabled = false;
      }
    }

    async function logout() {
      try { await AuthAPI.signOut(); } catch (e) {}
      location.reload();
    }

    // å›è½¦æäº¤
    document.getElementById('login-password').addEventListener('keydown', e => {
      if (e.key === 'Enter') submitLogin();
    });

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    (async function checkAuth() {
      const session = await AuthAPI.getSession();
      if (session) {
        document.getElementById('login-overlay').style.display = 'none';
        initAdmin();
      }
    })();

    // ===== æ•°æ®ç®¡ç† =====
    const CATEGORY_MAP_ADMIN = {
      frontend: 'å‰ç«¯å¼€å‘',
      backend: 'åç«¯æŠ€æœ¯',
      learning: 'å­¦ä¹ æ–¹æ³•',
      life: 'ç”Ÿæ´»éšç¬”'
    };

    let articles = [];
    let currentId = null;

    async function initAdmin() {
      await loadArticles();
      renderSidebar();
    }

    // è¯»å–æ–‡ç« åˆ—è¡¨
    async function loadArticles() {
      try {
        articles = await ArticlesAPI.getAll();
      } catch (e) {
        showToast('åŠ è½½æ–‡ç« å¤±è´¥: ' + e.message, true);
      }
    }

    // ===== Tab åˆ‡æ¢ =====
    function switchTab(tab) {
      document.querySelectorAll('.admin-tab').forEach((t, i) => {
        t.classList.toggle('admin-tab--active', ['articles','comments','messages'][i] === tab);
      });
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('tab-panel--active'));
      document.getElementById('tab-' + tab).classList.add('tab-panel--active');

      if (tab === 'comments') loadCommentsAdmin();
      if (tab === 'messages') loadMessagesAdmin();
    }

    // ===== ä¾§è¾¹æ æ¸²æŸ“ =====
    function renderSidebar() {
      const list = document.getElementById('article-list');
      const count = document.getElementById('article-count');
      count.textContent = articles.length + ' ç¯‡';

      list.innerHTML = articles.map(a => `
        <div class="sidebar__item ${a.id === currentId ? 'sidebar__item--active' : ''}" onclick="selectArticle(${a.id})">
          <div class="sidebar__item-title">${a.emoji || 'ğŸ“'} ${a.title || 'æ— æ ‡é¢˜'}</div>
          <div class="sidebar__item-meta">
            <span class="sidebar__item-category">${a.categoryName || 'æœªåˆ†ç±»'}</span>
            <span>${a.date || ''}</span>
          </div>
        </div>
      `).join('');
    }

    // ===== æ–‡ç« æ“ä½œ =====
    function hasUnsavedChanges() {
      if (currentId === null) return false;
      
      const article = articles.find(a => a.id === currentId);
      if (!article) return false;
      
      const currentTitle = document.getElementById('ed-title').value || '';
      const currentContent = document.getElementById('ed-content').innerHTML || '';
      const currentCategory = document.getElementById('ed-category').value || 'frontend';
      const currentTags = document.getElementById('ed-tags').value || '';
      const currentEmoji = document.getElementById('ed-emoji').value || 'ğŸ“';
      
      const savedTitle = article.title || '';
      const savedContent = article.content || '';
      const savedCategory = article.category || 'frontend';
      const savedTags = (article.tags || []).join(', ');
      const savedEmoji = article.emoji || 'ğŸ“';
      
      return currentTitle !== savedTitle || 
             currentContent !== savedContent ||
             currentCategory !== savedCategory ||
             currentTags !== savedTags ||
             currentEmoji !== savedEmoji;
    }

    async function createNew() {
      // Check for unsaved changes before creating new article
      if (hasUnsavedChanges()) {
        const shouldSave = confirm('å½“å‰æ–‡ç« æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ');
        if (shouldSave) {
          await saveArticle();
        }
      }
      
      const newArticle = {
        title: '',
        category: 'frontend',
        date: new Date().toISOString().slice(0, 10),
        readTime: 'çº¦ 5 åˆ†é’Ÿ',
        excerpt: '',
        tags: [],
        emoji: 'ğŸ“',
        gradient: 'linear-gradient(135deg, #6c5ce7, #a29bfe)',
        featured: false,
        content: '',
        published: true
      };
      try {
        const created = await ArticlesAPI.create(newArticle);
        await loadArticles();
        selectArticleData(created);
        renderSidebar();
        showToast('æ–°æ–‡ç« å·²åˆ›å»ºï¼Œå¼€å§‹å†™ä½œå§ï¼');
        document.getElementById('sidebar').classList.remove('sidebar--open');
      } catch (e) {
        showToast('åˆ›å»ºå¤±è´¥: ' + e.message, true);
      }
    }

    async function selectArticle(id) {
      // Check for unsaved changes before switching articles
      if (hasUnsavedChanges()) {
        const shouldSave = confirm('å½“å‰æ–‡ç« æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ');
        if (shouldSave) {
          await saveArticle();
        }
      }
      
      const article = articles.find(a => a.id === id);
      if (!article) return;
      selectArticleData(article);
    }

    function selectArticleData(article) {
      currentId = article.id;

      document.getElementById('empty-state').style.display = 'none';
      const wrapper = document.getElementById('editor-wrapper');
      wrapper.style.display = 'flex';

      document.getElementById('ed-title').value = article.title || '';
      document.getElementById('ed-category').value = article.category || 'frontend';
      document.getElementById('ed-tags').value = (article.tags || []).join(', ');
      document.getElementById('ed-emoji').value = article.emoji || 'ğŸ“';
      document.getElementById('ed-content').innerHTML = article.content || '';

      document.querySelectorAll('.setting-color').forEach(el => {
        el.classList.toggle('setting-color--active', el.dataset.gradient === article.gradient);
      });

      const sw = document.getElementById('ed-featured');
      sw.classList.toggle('switch--on', !!article.featured);

      renderSidebar();
      document.getElementById('sidebar').classList.remove('sidebar--open');
    }

    async function saveArticle() {
      if (currentId === null) return;

      const title = document.getElementById('ed-title').value.trim();
      const category = document.getElementById('ed-category').value;
      const tags = document.getElementById('ed-tags').value.split(/[,ï¼Œ]/).map(t => t.trim()).filter(Boolean);
      const emoji = document.getElementById('ed-emoji').value.trim() || 'ğŸ“';
      const content = document.getElementById('ed-content').innerHTML;
      const featured = document.getElementById('ed-featured').classList.contains('switch--on');
      const activeColor = document.querySelector('.setting-color--active');
      const gradient = activeColor ? activeColor.dataset.gradient : 'linear-gradient(135deg, #6c5ce7, #a29bfe)';

      if (!title) {
        showToast('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', true);
        document.getElementById('ed-title').focus();
        return;
      }

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      const plainText = tempDiv.textContent || '';
      const excerpt = plainText.substring(0, 100).trim() + (plainText.length > 100 ? '...' : '');
      const minutes = Math.max(1, Math.ceil(plainText.length / 400));
      const readTime = 'çº¦ ' + minutes + ' åˆ†é’Ÿ';

      try {
        await ArticlesAPI.update(currentId, {
          title, category, tags, emoji, content, featured, gradient,
          excerpt, readTime,
          date: articles.find(a => a.id === currentId)?.date || new Date().toISOString().slice(0, 10),
          published: true
        });
        await loadArticles();
        renderSidebar();
        showToast('æ–‡ç« å·²ä¿å­˜å‘å¸ƒï¼');
      } catch (e) {
        showToast('ä¿å­˜å¤±è´¥: ' + e.message, true);
      }
    }

    async function deleteArticle() {
      try {
        var edContent = document.getElementById('ed-content');
        if (edContent && edContent.blur) edContent.blur();

        if (currentId === null) {
          showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ç« ', true);
          return;
        }
        var article = articles.find(function(a) { return a.id === currentId; });
        if (!article) {
          showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ç« ', true);
          return;
        }
        if (!confirm('ç¡®å®šè¦åˆ é™¤ã€Œ' + (article.title || 'æ— æ ‡é¢˜') + 'ã€å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚')) return;

        await ArticlesAPI.delete(currentId);
        currentId = null;
        await loadArticles();
        renderSidebar();

        document.getElementById('empty-state').style.display = 'flex';
        document.getElementById('editor-wrapper').style.display = 'none';
        showToast('æ–‡ç« å·²åˆ é™¤');
      } catch (e) {
        showToast('åˆ é™¤å¤±è´¥ï¼š' + (e.message || e), true);
      }
    }

    function previewArticle() {
      if (currentId === null) return;
      window.open('article.html?id=' + currentId, '_blank');
    }

    // ===== è¯„è®ºç®¡ç† =====
    async function loadCommentsAdmin() {
      const listEl = document.getElementById('comments-data-list');
      listEl.innerHTML = '<p style="color:#888;padding:20px 0;">åŠ è½½ä¸­...</p>';
      try {
        const comments = await CommentsAPI.getAll();
        if (!comments.length) {
          listEl.innerHTML = '<p style="color:#888;padding:20px 0;">æš‚æ— è¯„è®º</p>';
          return;
        }
        listEl.innerHTML = comments.map(c => `
          <div class="data-item ${c.approved ? 'data-item--approved' : 'data-item--pending'}">
            <div class="data-item__header">
              <div>
                <strong>${escapeHtml(c.author_name)}</strong>
                ${c.author_email ? '<span style="color:#888;font-size:13px;margin-left:8px;">' + escapeHtml(c.author_email) + '</span>' : ''}
                <span class="badge ${c.approved ? 'badge--approved' : 'badge--pending'}" style="margin-left:8px;">${c.approved ? 'å·²å®¡æ ¸' : 'å¾…å®¡æ ¸'}</span>
              </div>
              <div class="data-item__actions">
                ${!c.approved ? '<button class="btn btn--primary btn--small" onclick="approveComment(' + c.id + ')">é€šè¿‡</button>' : ''}
                <button class="btn btn--danger btn--small" onclick="deleteComment(' + c.id + ')">åˆ é™¤</button>
              </div>
            </div>
            <div class="data-item__meta">
              æ–‡ç« ï¼š${c.articles ? escapeHtml(c.articles.title) : 'ID#' + c.article_id}
              &nbsp;Â·&nbsp; ${new Date(c.created_at).toLocaleString('zh-CN')}
            </div>
            <div class="data-item__content" style="margin-top:8px;">${escapeHtml(c.content)}</div>
          </div>
        `).join('');
      } catch (e) {
        listEl.innerHTML = '<p style="color:#e74c3c;padding:20px 0;">åŠ è½½å¤±è´¥: ' + e.message + '</p>';
      }
    }

    async function approveComment(id) {
      try {
        await CommentsAPI.approve(id);
        showToast('è¯„è®ºå·²é€šè¿‡å®¡æ ¸');
        loadCommentsAdmin();
      } catch (e) {
        showToast('æ“ä½œå¤±è´¥: ' + e.message, true);
      }
    }

    async function deleteComment(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
      try {
        await CommentsAPI.delete(id);
        showToast('è¯„è®ºå·²åˆ é™¤');
        loadCommentsAdmin();
      } catch (e) {
        showToast('åˆ é™¤å¤±è´¥: ' + e.message, true);
      }
    }

    // ===== ç•™è¨€ç®¡ç† =====
    async function loadMessagesAdmin() {
      const listEl = document.getElementById('messages-data-list');
      listEl.innerHTML = '<p style="color:#888;padding:20px 0;">åŠ è½½ä¸­...</p>';
      try {
        const messages = await ContactAPI.getAll();
        if (!messages.length) {
          listEl.innerHTML = '<p style="color:#888;padding:20px 0;">æš‚æ— ç•™è¨€</p>';
          return;
        }
        listEl.innerHTML = messages.map(m => `
          <div class="data-item">
            <div class="data-item__header">
              <div>
                <strong>${escapeHtml(m.name)}</strong>
                <span style="color:#888;font-size:13px;margin-left:8px;">${escapeHtml(m.email)}</span>
                <span class="badge ${m.read ? 'badge--read' : 'badge--unread'}" style="margin-left:8px;">${m.read ? 'å·²è¯»' : 'æœªè¯»'}</span>
              </div>
              <div class="data-item__actions">
                ${!m.read ? '<button class="btn btn--ghost btn--small" onclick="markMessageRead(' + m.id + ')">æ ‡è®°å·²è¯»</button>' : ''}
              </div>
            </div>
            <div class="data-item__meta">
              ${m.subject ? 'ä¸»é¢˜ï¼š' + escapeHtml(m.subject) + ' &nbsp;Â·&nbsp; ' : ''}
              ${new Date(m.created_at).toLocaleString('zh-CN')}
            </div>
            <div class="data-item__content" style="margin-top:8px;">${escapeHtml(m.message)}</div>
          </div>
        `).join('');
      } catch (e) {
        listEl.innerHTML = '<p style="color:#e74c3c;padding:20px 0;">åŠ è½½å¤±è´¥: ' + e.message + '</p>';
      }
    }

    async function markMessageRead(id) {
      try {
        await ContactAPI.markRead(id);
        loadMessagesAdmin();
      } catch (e) {
        showToast('æ“ä½œå¤±è´¥: ' + e.message, true);
      }
    }

    // ===== å¯Œæ–‡æœ¬ç¼–è¾‘ =====
    function fmt(command, value) {
      document.getElementById('ed-content').focus();
      if (command === 'formatBlock') {
        document.execCommand('formatBlock', false, '<' + value + '>');
      } else {
        document.execCommand(command, false, value || null);
      }
    }

    function insertBlockquote() {
      document.getElementById('ed-content').focus();
      document.execCommand('formatBlock', false, '<blockquote>');
    }

    function insertCode() {
      const editor = document.getElementById('ed-content');
      editor.focus();
      const selection = window.getSelection();
      const text = selection.toString() || '// åœ¨è¿™é‡Œè¾“å…¥ä»£ç ';
      const pre = document.createElement('pre');
      const code = document.createElement('code');
      code.textContent = text;
      pre.appendChild(code);

      const range = selection.getRangeAt(0);
      range.deleteContents();
      range.insertNode(pre);

      const p = document.createElement('p');
      p.innerHTML = '<br>';
      pre.parentNode.insertBefore(p, pre.nextSibling);

      const newRange = document.createRange();
      newRange.setStart(p, 0);
      newRange.collapse(true);
      selection.removeAllRanges();
      selection.addRange(newRange);
    }

    function insertInlineCode() {
      const selection = window.getSelection();
      const text = selection.toString() || 'ä»£ç ';
      document.execCommand('insertHTML', false, '<code>' + text + '</code>&nbsp;');
    }

    // ===== UI è¾…åŠ© =====
    function toggleSwitch(el) {
      el.classList.toggle('switch--on');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('sidebar--open');
    }

    function escapeHtml(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // é¢œè‰²é€‰æ‹©
    document.getElementById('color-picker').addEventListener('click', (e) => {
      const target = e.target.closest('.setting-color');
      if (!target) return;
      document.querySelectorAll('.setting-color').forEach(el => el.classList.remove('setting-color--active'));
      target.classList.add('setting-color--active');
    });

    // Toast æç¤º
    function showToast(msg, isError) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast toast--show' + (isError ? ' toast--error' : '');
      setTimeout(() => { toast.className = 'toast'; }, 2500);
    }

    // ===== é”®ç›˜å¿«æ·é”® =====
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveArticle();
      }
    });

    // åˆ é™¤æŒ‰é’®äº‹ä»¶å§”æ‰˜
    document.addEventListener('click', function(e) {
      var btn = e.target.closest ? e.target.closest('#btn-delete') : (e.target.id === 'btn-delete' ? e.target : null);
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      deleteArticle();
    });
  </script>
</body>
</html>
